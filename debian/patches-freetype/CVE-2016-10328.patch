Origin: http://git.savannah.gnu.org/cgit/freetype/freetype2.git/commit/?id=beecf80a6deecbaf5d264d4f864451bde4fe98b8
From beecf80a6deecbaf5d264d4f864451bde4fe98b8 Mon Sep 17 00:00:00 2001
From: Werner Lemberg <wl@gnu.org>
Date: Fri, 16 Dec 2016 08:52:03 +0100
Subject: [cff] Fix heap buffer overflow (#49858).

* src/cff/cffparse.c (cff_parser_run): Add one more stack size
check.

CVE-2016-10328

[Dropped modification to Changelog to avoid conflicts. Converted dynamic
 parser stack size limit to CFF_MAX_STACK_DEPTH, change thanks to
 Markus Koschany <apo@debian.org>. --sbeattie]

---
 ChangeLog          |  7 +++++++
 src/cff/cffparse.c | 10 +++++++---
 2 files changed, 14 insertions(+), 3 deletions(-)

Index: freetype-2.4.8/src/cff/cffparse.c
===================================================================
--- freetype-2.4.8.orig/src/cff/cffparse.c
+++ freetype-2.4.8/src/cff/cffparse.c
@@ -926,13 +926,17 @@
         /* and look for it in our current list.                            */
 
         FT_UInt                   code;
-        FT_UInt                   num_args = (FT_UInt)
-                                             ( parser->top - parser->stack );
+        FT_UInt                   num_args;
         const CFF_Field_Handler*  field;
 
 
+        if ( (FT_UInt)( parser->top - parser->stack ) >= CFF_MAX_STACK_DEPTH )
+          goto Stack_Overflow;
+
+        num_args     = (FT_UInt)( parser->top - parser->stack );
         *parser->top = p;
-        code = v;
+        code         = v;
+
         if ( v == 12 )
         {
           /* two byte operator */
